<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI T·ª± ƒê·ªông ƒêi·ªÅn Google Form (ƒê∆°n Gi·∫£n Nh·∫•t)</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* M√†u n·ªÅn nh·∫π */
            min-height: 100vh;
        }
        .container {
            max-width: 90%;
            margin: auto;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 800px;
            }
        }
        .input-group {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
        }
        /* Spinner CSS */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6 border-b pb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-2 text-indigo-500" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            AI T·ª± ƒê·ªông ƒêi·ªÅn Google Form
        </h1>

        <div id="messageBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">L∆∞u √Ω:</strong>
            <span class="block sm:inline" id="messageText"></span>
        </div>

        <!-- Form URL Input -->
        <div class="input-group">
            <label for="formUrl" class="block text-sm font-medium text-gray-700 mb-1">1. Link Google Form (d·∫°ng /viewform)</label>
            <input type="url" id="formUrl" value="https://docs.google.com/forms/d/e/FORM_ID/viewform" placeholder="D√°n link Form c·ªßa b·∫°n v√†o ƒë√¢y..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
        </div>
        
        <!-- Form Configuration (The only remaining manual step) -->
        <div class="input-group p-4 bg-yellow-50 rounded-xl border border-yellow-200">
            <label for="formConfig" class="block text-sm font-medium text-gray-700 mb-1">
                2. C·∫•u h√¨nh Form JSON (entry.ID: Label)
            </label>
            <p class="text-xs text-yellow-700 mb-2 font-bold">‚ö†Ô∏è B∆Ø·ªöC B·∫ÆT BU·ªòC. ID Form (entry.xxxxxx) c·∫ßn ƒë∆∞·ª£c d√°n v√†o ƒë√¢y ƒë·ªÉ Form ho·∫°t ƒë·ªông.</p>
            <textarea id="formConfig" rows="8" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-xs focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">{
    "entry.123456789": "H·ªç v√† T√™n",
    "entry.987654321": "ƒê·ªãa ch·ªâ Email"
}</textarea>
            
            <!-- Hidden Instruction Guide -->
            <div id="id-guide" class="mt-4 p-3 bg-white border border-gray-300 rounded-lg shadow-inner">
                <h3 class="font-bold text-sm mb-2 text-indigo-600 cursor-pointer" onclick="document.getElementById('guide-content').classList.toggle('hidden');">
                    <span class="text-green-600 mr-2">üí°</span> C√°ch T√¨m ID (entry.xxxxxx) NHANH CH√ìNG tr√™n ƒêi·ªán Tho·∫°i (B·∫•m ƒë·ªÉ xem)
                </h3>
                <div id="guide-content" class="hidden text-xs text-gray-600 space-y-2">
                    <p>ƒê√¢y l√† b∆∞·ªõc th·ªß c√¥ng duy nh·∫•t, nh∆∞ng r·∫•t ƒë∆°n gi·∫£n n·∫øu b·∫°n l√†m theo 3 b∆∞·ªõc sau:</p>
                    <ol class="list-decimal ml-5 space-y-1">
                        <li><strong>M·ªü Form v·ªõi M√£ Ngu·ªìn:</strong> Tr√™n tr√¨nh duy·ªát (Chrome/Safari) ƒëang m·ªü Form, b·∫°n nh·∫•p v√†o thanh ƒë·ªãa ch·ªâ v√† th√™m ti·ªÅn t·ªë <code>view-source:</code> v√†o ƒë·∫ßu URL. V√≠ d·ª•: ƒë·ªïi <code>https://.../viewform</code> th√†nh <code>view-source:https://.../viewform</code>.</li>
                        <li><strong>T√¨m ki·∫øm Nhanh:</strong> Khi m√£ ngu·ªìn hi·ªán ra, s·ª≠ d·ª•ng t√≠nh nƒÉng **"T√¨m trong trang"** (Find in Page) c·ªßa tr√¨nh duy·ªát v√† g√µ <code>entry.</code></li>
                        <li><strong>Sao ch√©p v√† D√°n:</strong> B·∫°n s·∫Ω th·∫•y c√°c ƒëo·∫°n nh∆∞ <code>name="entry.123456789"</code>. H√£y sao ch√©p **ID** (`entry.123456789`) v√† ƒëi·ªÅn v√†o khung JSON b√™n tr√™n, ƒë·ªëi chi·∫øu n√≥ v·ªõi t√™n c√¢u h·ªèi b·∫°n th·∫•y tr√™n Form.</li>
                    </ol>
                    <p class="font-semibold text-red-500">Ch·ªâ c·∫ßn l√†m b∆∞·ªõc n√†y m·ªôt l·∫ßn cho m·ªói Form. Sau ƒë√≥, b·∫°n c√≥ th·ªÉ ch·∫°y t·ª± ƒë·ªông nhi·ªÅu l·∫ßn.</p>
                </div>
            </div>
        </div>
        
        <!-- Number of Submissions -->
        <div class="input-group">
            <label for="submissionCount" class="block text-sm font-medium text-gray-700 mb-1">3. S·ªë l∆∞·ª£ng l·∫ßn ƒëi·ªÅn t·ª± ƒë·ªông</label>
            <input type="number" id="submissionCount" value="3" min="1" max="10" placeholder="S·ªë l·∫ßn g·ª≠i Form" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
        </div>

        <!-- Start Button -->
        <button onclick="startAutoFill()" id="startButton" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
            <svg id="submitIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <div id="buttonTextContainer" class="flex items-center">
                <span id="buttonText">B·∫Øt ƒë·∫ßu ƒêi·ªÅn Form T·ª± ƒê·ªông</span>
                <div id="loadingSpinner" class="hidden ml-3 h-5 w-5 border-4 border-white border-solid rounded-full loader"></div>
            </div>
        </button>

        <!-- Submission Log -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-3">4. Nh·∫≠t k√Ω ƒêi·ªÅn Form</h2>
            <div id="logContainer" class="bg-gray-100 p-4 rounded-lg h-64 overflow-y-scroll border border-gray-300">
                <p class="text-sm text-gray-500">Ch·ªù ƒë·ª£i l·ªánh b·∫Øt ƒë·∫ßu...</p>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh API key ƒë·ªÉ g·ªçi Gemini
        const apiKey = "";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

        // --- H√ÄM TI·ªÜN √çCH UI/NETWORK ---

        function showMessage(text, isError = true) {
            const box = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            box.classList.remove('hidden', 'bg-red-100', 'bg-yellow-100', 'border-red-400', 'border-yellow-400', 'text-red-700', 'text-yellow-700');

            if (isError) {
                box.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else {
                box.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
            }
            messageText.textContent = text;
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString();
            
            let colorClass = 'text-gray-700';
            if (type === 'success') colorClass = 'text-green-600 font-medium';
            if (type === 'error') colorClass = 'text-red-600 font-medium';
            if (type === 'warn') colorClass = 'text-yellow-600';
            
            p.className = `text-sm mb-1 ${colorClass}`;
            p.innerHTML = `[${timestamp}] ${message}`;
            
            if (logContainer.firstChild && logContainer.firstChild.className.includes('text-gray-500')) {
                 logContainer.removeChild(logContainer.firstChild); 
            }
            logContainer.prepend(p);
        }

        function toggleRunningState(isRunning) {
            document.getElementById('startButton').disabled = isRunning;
            document.getElementById('formUrl').disabled = isRunning;
            document.getElementById('submissionCount').disabled = isRunning;
            document.getElementById('formConfig').disabled = isRunning;
            
            const buttonText = document.getElementById('buttonText');
            const spinner = document.getElementById('loadingSpinner');
            const icon = document.getElementById('submitIcon');
            
            if (isRunning) {
                buttonText.textContent = 'ƒêang ƒêi·ªÅn... Vui l√≤ng ch·ªù';
                spinner.classList.remove('hidden');
                icon.classList.add('hidden');
            } else {
                buttonText.textContent = 'B·∫Øt ƒë·∫ßu ƒêi·ªÅn Form T·ª± ƒê·ªông';
                spinner.classList.add('hidden');
                icon.classList.remove('hidden');
            }
        }
        
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`[API Retry] Th·ª≠ l·∫°i sau ${Math.round(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- CH·ª®C NƒÇNG CH√çNH ---

        async function generateAiData(fieldLabels) {
            const labelsList = Object.values(fieldLabels).join('", "');
            const prompt = `B·∫°n l√† m·ªôt h·ªá th·ªëng t·∫°o d·ªØ li·ªáu th·ª≠ nghi·ªám th√¥ng minh. H√£y t·∫°o ra m·ªôt b·ªô d·ªØ li·ªáu c√≥ th·∫≠t, ƒë·ªôc ƒë√°o, v√† ho√†n to√†n ng·∫´u nhi√™n (s·ª≠ d·ª•ng ti·∫øng Vi·ªát, kh√¥ng l·∫∑p l·∫°i) cho c√°c tr∆∞·ªùng sau. H√£y ƒë·∫£m b·∫£o d·ªØ li·ªáu h·ª£p l√Ω v·ªõi t√™n tr∆∞·ªùng. V√≠ d·ª•: n·∫øu tr∆∞·ªùng l√† "H·ªç v√† T√™n", b·∫°n ph·∫£i tr·∫£ v·ªÅ m·ªôt t√™n ng∆∞·ªùi Vi·ªát Nam. N·∫øu tr∆∞·ªùng l√† "Ng√†y sinh (dd/mm/yyyy)", h√£y tr·∫£ v·ªÅ m·ªôt ng√†y sinh h·ª£p l·ªá.

Y√äU C·∫¶U QUAN TR·ªåNG:
1. ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c gi√° tr·ªã (value) trong JSON ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng d∆∞·ªõi d·∫°ng chu·ªói (string).
2. Key c·ªßa JSON ph·∫£i l√† CH√çNH X√ÅC t√™n c√¢u h·ªèi (Label) ƒë∆∞·ª£c cung c·∫•p.

Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn t·∫°o d·ªØ li·ªáu: ["${labelsList}"]`;
            
            const responseProperties = {};
            const propertyOrdering = [];
            
            for (const label of Object.values(fieldLabels)) {
                responseProperties[label] = { "type": "STRING" };
                propertyOrdering.push(label);
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: responseProperties,
                        propertyOrdering: propertyOrdering
                    }
                }
            };
            
            log("ƒêang g·ªçi AI (Gemini) ƒë·ªÉ t·∫°o d·ªØ li·ªáu ng·∫´u nhi√™n...", 'warn');

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithBackoff(apiUrl, options);
            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && 
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                
                const jsonText = result.candidates[0].content.parts[0].text;
                try {
                    const aiData = JSON.parse(jsonText);
                    log("AI ƒë√£ t·∫°o d·ªØ li·ªáu th√†nh c√¥ng.", 'info');
                    return aiData;
                } catch (e) {
                    log("L·ªói: AI tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng JSON kh√¥ng h·ª£p l·ªá.", 'error');
                    throw new Error("D·ªØ li·ªáu AI kh√¥ng ph·∫£i l√† JSON h·ª£p l·ªá.");
                }
            } else {
                log("L·ªói: AI kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu.", 'error');
                throw new Error("AI kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu.");
            }
        }

        async function submitFormEntry(formResponseUrl, entryMap, aiData) {
            
            const payload = {};
            let logData = {};
            
            // X√¢y d·ª±ng payload ƒë·ªÉ g·ª≠i (ID: D·ªØ li·ªáu AI)
            for (const [entryId, label] of Object.entries(entryMap)) {
                if (aiData.hasOwnProperty(label)) {
                    payload[entryId] = aiData[label];
                    logData[label] = aiData[label]; 
                } else {
                    payload[entryId] = ""; 
                    logData[label] = "KH√îNG C√ì D·ªÆ LI·ªÜU T·ª™ AI";
                }
            }

            const options = {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'User-Agent': 'Mozilla/5.0' // Gi·∫£ l·∫≠p user-agent ƒë·ªÉ tƒÉng kh·∫£ nƒÉng th√†nh c√¥ng
                },
                body: new URLSearchParams(payload).toString()
            };
            
            log(`D·ªØ li·ªáu g·ª≠i: ${JSON.stringify(logData)}`, 'warn');

            try {
                // Google Forms s·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c POST ƒë·ªÉ g·ª≠i d·ªØ li·ªáu
                const response = await fetchWithBackoff(formResponseUrl, options);
                
                if (response.ok || response.status === 302) {
                    log("G·ª≠i Form th√†nh c√¥ng!", 'success');
                    return true;
                } else {
                    // X·ª≠ l√Ω c√°c l·ªói HTTP kh√°c
                    if (response.status >= 400) {
                        log(`L·ªói HTTP khi g·ª≠i: ${response.status}`, 'error');
                        return false;
                    }
                    log("G·ª≠i Form th√†nh c√¥ng (Tr·∫°ng th√°i kh√°c 200/302 nh∆∞ng Form ƒë√£ nh·∫≠n).", 'success');
                    return true;
                }

            } catch (error) {
                log(`L·ªói k·∫øt n·ªëi ho·∫∑c network: ${error.message}`, 'error');
                return false;
            }
        }


        async function startAutoFill() {
            toggleRunningState(true);
            document.getElementById('messageBox').classList.add('hidden');
            document.getElementById('logContainer').innerHTML = '';
            
            const formUrl = document.getElementById('formUrl').value.trim();
            const count = parseInt(document.getElementById('submissionCount').value, 10);
            let entryMap;

            if (!formUrl || !formUrl.includes("/viewform")) {
                showMessage("L·ªói: URL Form ph·∫£i c√≥ d·∫°ng https://docs.google.com/forms/d/e/FORM_ID/viewform");
                toggleRunningState(false);
                return;
            }

            const formResponseUrl = formUrl.replace("/viewform", "/formResponse");

            try {
                const configText = document.getElementById('formConfig').value.trim();
                entryMap = JSON.parse(configText);
                
                if (Object.keys(entryMap).length === 0) {
                    showMessage("L·ªói: C·∫•u h√¨nh Form JSON kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng. Vui l√≤ng ƒëi·ªÅn ID v√† Label c·ªßa Form v√†o khung JSON.", true);
                    toggleRunningState(false);
                    return;
                }
                
                log(`ƒê√£ t·∫£i ${Object.keys(entryMap).length} tr∆∞·ªùng Form. Target URL: ${formResponseUrl}`, 'info');

            } catch (e) {
                showMessage("L·ªói: C·∫•u h√¨nh Form JSON kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i c√∫ ph√°p JSON.", true);
                console.error(e);
                toggleRunningState(false);
                return;
            }

            let successCount = 0;
            let totalCount = count;
            
            for (let i = 1; i <= totalCount; i++) {
                log(`--- B·∫Øt ƒë·∫ßu ƒëi·ªÅn Form l·∫ßn th·ª© ${i} / ${totalCount} ---`, 'info');
                try {
                    const aiData = await generateAiData(entryMap);
                    const success = await submitFormEntry(formResponseUrl, entryMap, aiData);
                    
                    if (success) {
                        successCount++;
                    }
                    
                    if (i < totalCount) {
                        const delay = randomInt(1000, 3000);
                        log(`Ho√†n th√†nh l·∫ßn ${i}. ƒêang ch·ªù ${delay / 1000}s tr∆∞·ªõc khi g·ª≠i ti·∫øp...`, 'warn');
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }

                } catch (error) {
                    log(`ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng trong l·∫ßn g·ª≠i ${i}: ${error.message}`, 'error');
                    break; 
                }
            }

            log(`--- HO√ÄN T·∫§T --- ƒê√£ g·ª≠i th√†nh c√¥ng ${successCount} / ${totalCount} l·∫ßn.`, 'success');
            toggleRunningState(false);
        }

    </script>
</body>
</html>

  
